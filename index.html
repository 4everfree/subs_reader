<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>SRT Sync & Editor</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f9; }
        .controls { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background: #eee; position: sticky; top: 0; }
        .time-col { width: 150px; font-family: monospace; }
        .edit-cell { outline: none; min-height: 1.2em; }
        .edit-cell:focus { background: #fffde7; border: 1px solid #ffd600; }
        button { padding: 8px 16px; cursor: pointer; border-radius: 4px; border: 1px solid #333; }
    </style>
</head>
<body>

<h2>Синхронизатор субтитров</h2>

<div class="controls">
    <input type="file" id="file1" accept=".srt">
    <input type="file" id="file2" accept=".srt">
    <button onclick="processFiles()">Синхронизировать</button>
    <button onclick="exportCombinedSRT()">Сохранить результат (SRT)</button>
</div>

<table id="subsTable">
    <thead>
    <tr>
        <th>Время (Начало --> Конец)</th>
        <th>Субтитр 1 (Оригинал)</th>
        <th>Субтитр 2 (Перевод)</th>
    </tr>
    </thead>
    <tbody>
    </tbody>
</table>

<script>
    let subtitlesData = [];

    // Функция парсинга SRT
    function parseSRT(data) {
        const items = [];
        const blocks = data.trim().split(/\n\s*\n/);
        blocks.forEach(block => {
            const lines = block.split('\n');
            if (lines.length >= 3) {
                const timeMatch = lines[1].match(/(\d{2}:\d{2}:\d{2},\d{3}) --> (\d{2}:\d{2}:\d{2},\d{3})/);
                if (timeMatch) {
                    items.push({
                        time: timeMatch[0],
                        start: timeMatch[1],
                        end: timeMatch[2],
                        text: lines.slice(2).join('\n')
                    });
                }
            }
        });
        return items;
    }

    async function processFiles() {
        const f1 = document.getElementById('file1').files[0];
        const f2 = document.getElementById('file2').files[0];

        if (!f1 || !f2) return alert("Выберите оба файла");

        const text1 = await f1.text();
        const text2 = await f2.text();

        const subs1 = parseSRT(text1);
        const subs2 = parseSRT(text2);

        // Простая логика синхронизации: берем тайминги из 1-го файла
        // и ищем ближайший по времени блок из 2-го файла
        subtitlesData = subs1.map(s1 => {
            const match = subs2.find(s2 => Math.abs(timeToMs(s1.start) - timeToMs(s2.start)) < 2000);
            return {
                time: s1.time,
                text1: s1.text,
                text2: match ? match.text : ""
            };
        });

        renderTable();
    }

    function timeToMs(t) {
        const [h, m, s] = t.split(':');
        const [sec, ms] = s.split(',');
        return h * 3600000 + m * 60000 + sec * 1000 + parseInt(ms);
    }

    function renderTable() {
        const tbody = document.querySelector('#subsTable tbody');
        tbody.innerHTML = '';
        subtitlesData.forEach((item, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="time-col">${item.time}</td>
                <td class="edit-cell" contenteditable="true" oninput="updateData(${index}, 'text1', this.innerText)">${item.text1}</td>
                <td class="edit-cell" contenteditable="true" oninput="updateData(${index}, 'text2', this.innerText)">${item.text2}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function updateData(index, field, value) {
        subtitlesData[index][field] = value;
    }

    function exportCombinedSRT() {
        let output = "";
        subtitlesData.forEach((item, i) => {
            output += `${i + 1}\n${item.time}\n${item.text1}\n---\n${item.text2}\n\n`;
        });

        const blob = new Blob([output], {type: "text/plain"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "combined_subtitles.srt";
        a.click();
    }
</script>
</body>
</html>