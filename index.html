<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Independent SRT Editor</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f8f9fa; }
        .controls {
            background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px;
            display: flex; gap: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Сетка колонок */
        .editor-grid { display: flex; gap: 10px; align-items: flex-start; }

        .column {
            background: #ebedef; border-radius: 8px; flex: 1;
            min-height: 500px; padding: 10px; border: 1px solid #ddd;
        }
        .column-header {
            font-weight: bold; text-align: center; padding: 10px;
            background: #455a64; color: white; border-radius: 6px; margin-bottom: 10px;
        }

        /* Стили ячеек */
        .cell {
            background: white; border: 1px solid #ccc; margin-bottom: 5px;
            padding: 10px; border-radius: 4px; position: relative;
            display: flex; align-items: center; gap: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .cell:hover { border-color: #2196f3; }

        .handle { cursor: grab; color: #aaa; font-size: 18px; user-select: none; }
        .content { flex-grow: 1; outline: none; min-height: 1.2em; word-break: break-word; }

        .btn-del {
            background: #ff5252; color: white; border: none; border-radius: 3px;
            width: 20px; height: 20px; cursor: pointer; font-size: 12px; line-height: 1;
        }

        /* Цвета для разных колонок */
        #col-time .cell { border-left: 4px solid #9c27b0; font-family: monospace; }
        #col-text1 .cell { border-left: 4px solid #2196f3; }
        #col-text2 .cell { border-left: 4px solid #4caf50; }

        button.save-btn { background: #2e7d32; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        .sortable-ghost { opacity: 0.3; background: #bbdefb !important; }
    </style>
</head>
<body>

<div class="controls">
    <input type="file" id="file1" accept=".srt">
    <input type="file" id="file2" accept=".srt">
    <button onclick="processFiles()">Загрузить</button>
    <button class="save-btn" onclick="exportData()">Скачать результат</button>
</div>

<div class="editor-grid">
    <div class="column">
        <div class="column-header">Время</div>
        <div id="col-time"></div>
    </div>
    <div class="column">
        <div class="column-header">Субтитр 1</div>
        <div id="col-text1"></div>
    </div>
    <div class="column">
        <div class="column-header">Субтитр 2</div>
        <div id="col-text2"></div>
    </div>
</div>

<script>
    // Инициализируем Sortable для каждой колонки отдельно
    const sortConfig = {
        animation: 150,
        handle: '.handle',
        ghostClass: 'sortable-ghost',
        group: false // Запрещаем перетаскивание МЕЖДУ колонками (только внутри одной)
    };

    Sortable.create(document.getElementById('col-time'), sortConfig);
    Sortable.create(document.getElementById('col-text1'), sortConfig);
    Sortable.create(document.getElementById('col-text2'), sortConfig);

    function createCell(text) {
        const div = document.createElement('div');
        div.className = 'cell';
        div.innerHTML = `
            <span class="handle">☰</span>
            <div class="content" contenteditable="true">${text}</div>
            <button class="btn-del" onclick="this.parentElement.remove()">✕</button>
        `;
        return div;
    }

    function parseSRT(data) {
        return data.trim().split(/\n\s*\n/).map(block => {
            const lines = block.split('\n');
            const timeMatch = lines[1]?.match(/(\d{2}:\d{2}:\d{2},\d{3}) --> (\d{2}:\d{2}:\d{2},\d{3})/);
            return timeMatch ? { time: timeMatch[0], start: timeMatch[1], text: lines.slice(2).join('\n') } : null;
        }).filter(Boolean);
    }

    async function processFiles() {
        const f1 = document.getElementById('file1').files[0];
        const f2 = document.getElementById('file2').files[0];
        if (!f1 || !f2) return alert("Выберите оба файла");

        const [t1, t2] = await Promise.all([f1.text(), f2.text()]);
        const subs1 = parseSRT(t1);
        const subs2 = parseSRT(t2);

        const colT = document.getElementById('col-time');
        const col1 = document.getElementById('col-text1');
        const col2 = document.getElementById('col-text2');

        colT.innerHTML = col1.innerHTML = col2.innerHTML = '';

        // Наполняем колонки
        subs1.forEach(s1 => {
            colT.appendChild(createCell(s1.time));
            col1.appendChild(createCell(s1.text));

            // Ищем совпадение по времени для второй колонки
            const match = subs2.find(s2 => s2.start.substring(0,8) === s1.start.substring(0,8));
            col2.appendChild(createCell(match ? match.text : ""));
        });
    }

    function exportData() {
        const times = document.querySelectorAll('#col-time .content');
        const texts1 = document.querySelectorAll('#col-text1 .content');
        const texts2 = document.querySelectorAll('#col-text2 .content');

        // Определяем максимальное количество строк
        const maxLen = Math.max(times.length, texts1.length, texts2.length);
        let srtOutput = "";

        for (let i = 0; i < maxLen; i++) {
            const time = times[i] ? times[i].innerText.trim() : "00:00:00,000 --> 00:00:00,000";
            const t1 = texts1[i] ? texts1[i].innerText.trim() : "";
            const t2 = texts2[i] ? texts2[i].innerText.trim() : "";

            srtOutput += `${i + 1}\n${time}\n${t1}\n---\n${t2}\n\n`;
        }

        const blob = new Blob([srtOutput], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "independent_sync.srt";
        a.click();
    }
</script>
</body>
</html>