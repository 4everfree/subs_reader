<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>SRT Editor with Blur Effect</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --border-color: #cbd5e0;
            --time-bg: #f8f9fa;
            --header-bg: #2d3748;
            --accent: #4299e1;
        }
        body { font-family: 'Segoe UI', sans-serif; background: #edf2f7; padding: 20px; margin: 0; }

        /* --- CSS –î–õ–Ø –≠–§–§–ï–ö–¢–ê BLUR --- */
        .blurred-text {
            filter: blur(4px); /* –†–µ–≥—É–ª–∏—Ä—É–π—Ç–µ —Å–∏–ª—É —Ä–∞–∑–º—ã—Ç–∏—è –∑–¥–µ—Å—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, 2px –∏–ª–∏ 6px) */
            transition: filter 0.3s ease;
            cursor: help; /* –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ —Å —Ç–µ–∫—Å—Ç–æ–º —á—Ç–æ-—Ç–æ –Ω–µ —Ç–∞–∫ */
        }
        /* –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –Ω–∏–∂–µ, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å —Ç–µ–∫—Å—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –º—ã—à–∏ */
        /* .blurred-text:hover { filter: blur(0); } */

        /* –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ –º–µ–Ω—é —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */
        #format-menu {
            position: absolute;
            display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            background: #2d3748; color: white; padding: 5px; border-radius: 6px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 1000; gap: 5px;
        }
        #format-menu button {
            background: transparent; border: none; color: white; padding: 5px 10px;
            cursor: pointer; font-weight: bold; border-radius: 4px; font-size: 14px;
        }
        #format-menu button:hover { background: #4a5568; }

        /* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ */
        .top-bar {
            background: white; padding: 15px 20px; border-radius: 12px;
            display: flex; gap: 20px; margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); align-items: center;
        }
        .grid-wrapper {
            display: grid; grid-template-columns: 200px 1fr 1fr;
            background: white; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color); position: relative;
        }
        .col-header { background: var(--header-bg); color: white; padding: 15px; font-weight: bold; text-align: center; position: relative; }
        .resizer { position: absolute; right: 0; top: 0; width: 5px; height: 100%; cursor: col-resize; z-index: 10; }
        .resizer:hover, .resizer.resizing { background: var(--accent); }
        .column-list {
            display: flex; flex-direction: column; min-height: 650px; background: white;
            border-right: 1px solid var(--border-color); transition: background 0.3s;
        }
        .column-list.drag-over { background: #ebf8ff; outline: 2px dashed var(--accent); }
        .cell { border-bottom: 1px solid #e2e8f0; padding: 10px; min-height: 70px; display: flex; align-items: flex-start; gap: 8px; }
        #list-time .cell { background: var(--time-bg); }
        .handle { cursor: grab; color: #a0aec0; font-size: 20px; user-select: none; }
        .content { flex: 1; outline: none; font-size: 14px; line-height: 1.5; white-space: pre-wrap; word-break: break-word; }
        .btn-del { border: none; background: none; color: #cbd5e0; cursor: pointer; font-size: 14px; }
        .btn-del:hover { color: #e53e3e; }
        .btn-main { background: #4a5568; color: white; border: none; padding: 10px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-save { background: #38a169; }
    </style>
</head>
<body>

<div id="format-menu">
    <button onclick="format('bold')" title="–ñ–∏—Ä–Ω—ã–π">B</button>
    <button onclick="format('italic')" title="–ö—É—Ä—Å–∏–≤"><i>I</i></button>
    <button onclick="format('underline')" title="–ü–æ–¥—á–µ—Ä–∫–Ω—É—Ç—ã–π"><u>U</u></button>
    <button onclick="applyBlur()" title="–†–∞–∑–º—ã—Ç—å —Ç–µ–∫—Å—Ç" style="font-size: 12px;">üå´ Blur</button>
</div>

<div class="top-bar">
    <div style="flex:1">
        <button class="btn-main" onclick="document.getElementById('hidden-file').click()">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã</button>
        <input type="file" id="hidden-file" multiple style="display:none" onchange="handleFileSelect(this.files)">
        <span style="font-size: 12px; color: #718096; margin-left: 10px;">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ SRT –Ω–∞ –∫–æ–ª–æ–Ω–∫–∏ –∏–ª–∏ –≤—ã–¥–µ–ª–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –º–µ–Ω—é</span>
    </div>
    <button class="btn-main btn-save" onclick="exportSRT()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>
</div>

<div class="grid-wrapper" id="mainGrid">
    <div class="col-header">–¢–∞–π–º–∫–æ–¥—ã <div class="resizer"></div></div>
    <div class="col-header">–°—É–±—Ç–∏—Ç—Ä 1 <div class="resizer"></div></div>
    <div class="col-header">–°—É–±—Ç–∏—Ç—Ä 2</div>

    <div id="list-time" class="column-list" id="list-time"></div>
    <div id="list-sub1" class="column-list" id="list-sub1"></div>
    <div id="list-sub2" class="column-list" id="list-sub2"></div>
</div>

<script>
    // --- –§–£–ù–ö–¶–ò–ò –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø ---

    // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (B, I, U)
    function format(cmd) {
        document.execCommand(cmd, false, null);
        // –ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª–æ
        document.getElementById('format-menu').style.display = 'none';
    }

    // –ö–∞—Å—Ç–æ–º–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ Blur
    function applyBlur() {
        const selection = window.getSelection();
        if (!selection.rangeCount) return;

        const range = selection.getRangeAt(0);
        const selectedText = range.toString();

        if (selectedText.length === 0) return;

        // –°–æ–∑–¥–∞–µ–º span —Å –∫–ª–∞—Å—Å–æ–º —Ä–∞–∑–º—ã—Ç–∏—è
        const span = document.createElement('span');
        span.className = 'blurred-text';

        // –ò–∑–≤–ª–µ–∫–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –∏ –ø–æ–º–µ—â–∞–µ–º –µ–≥–æ –≤–Ω—É—Ç—Ä—å span
        // extractContents() —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤–ª–æ–∂–µ–Ω–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç —É–∂–µ –∂–∏—Ä–Ω—ã–π)
        span.appendChild(range.extractContents());

        // –í—Å—Ç–∞–≤–ª—è–µ–º span –æ–±—Ä–∞—Ç–Ω–æ –≤ —Ç–µ–∫—Å—Ç
        range.insertNode(span);

        // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∏ —Å–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é
        selection.removeAllRanges();
        document.getElementById('format-menu').style.display = 'none';
    }


    // –õ–û–ì–ò–ö–ê –ü–û–Ø–í–õ–ï–ù–ò–Ø –ú–ï–ù–Æ
    const menu = document.getElementById('format-menu');
    let isMenuHovered = false;

    menu.addEventListener('mouseenter', () => isMenuHovered = true);
    menu.addEventListener('mouseleave', () => isMenuHovered = false);

    document.addEventListener('selectionchange', () => {
        const selection = window.getSelection();
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç –∏ –º—ã –Ω–µ –Ω–∞—Ö–æ–¥–∏–º—Å—è –Ω–∞–¥ —Å–∞–º–∏–º –º–µ–Ω—é
        if (selection.toString().length > 0 && !isMenuHovered && selection.anchorNode.parentElement.closest('.cell')) {
            const range = selection.getRangeAt(0);
            const rect = range.getBoundingClientRect();

            menu.style.display = 'flex';
            // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –º–µ–Ω—é –Ω–∞–¥ –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º
            menu.style.left = `${rect.left + (rect.width / 2) - (menu.offsetWidth / 2)}px`;
            // –†–∞–∑–º–µ—â–∞–µ–º —á—É—Ç—å –≤—ã—à–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è, —É—á–∏—Ç—ã–≤–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫—É
            menu.style.top = `${rect.top + window.scrollY - 45}px`;
        } else if (!isMenuHovered) {
            // –°–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é, –µ—Å–ª–∏ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ–ø–∞–ª–æ –∏ –º—ã—à–∫–∞ –Ω–µ –Ω–∞–¥ –º–µ–Ω—é
            menu.style.display = 'none';
        }
    });

    // --- –û–°–¢–ê–õ–¨–ù–û–ô –ö–û–î (DRAG&DROP, PARSING, RESIZE) –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô ---
    const columns = document.querySelectorAll('.column-list');
    columns.forEach(col => {
        col.addEventListener('dragover', e => { e.preventDefault(); col.classList.add('drag-over'); });
        col.addEventListener('dragleave', () => col.classList.remove('drag-over'));
        col.addEventListener('drop', async e => {
            e.preventDefault(); col.classList.remove('drag-over');
            if (e.dataTransfer.files.length > 0) processDroppedFile(e.dataTransfer.files[0], col.id);
        });
    });
    function handleFileSelect(files) { if(files.length > 0) processDroppedFile(files[0], 'list-sub1'); }
    async function processDroppedFile(file, targetColId) {
        const text = await file.text();
        const subs = parseSRT(text);
        if (subs.some(s => s.text.includes('---'))) fillAllColumns(subs);
        else fillSingleColumn(subs, targetColId);
    }
    function fillSingleColumn(subs, colId) {
        const container = document.getElementById(colId); container.innerHTML = '';
        subs.forEach(s => container.appendChild(createCell(colId === 'list-time' ? s.time : s.text)));
    }
    function fillAllColumns(subs) {
        const cT = document.getElementById('list-time'), c1 = document.getElementById('list-sub1'), c2 = document.getElementById('list-sub2');
        cT.innerHTML = c1.innerHTML = c2.innerHTML = '';
        subs.forEach(s => {
            const parts = s.text.split('---');
            cT.appendChild(createCell(s.time));
            c1.appendChild(createCell(parts[0]?.trim() || ""));
            c2.appendChild(createCell(parts[1]?.trim() || ""));
        });
    }
    function parseSRT(data) {
        const cleanData = data.replace(/^\uFEFF/, '').replace(/\r\n/g, '\n');
        const regex = /(\d+)\n(\d{2}:\d{2}:\d{2},\d{3} --> \d{2}:\d{2}:\d{2},\d{3})\n([\s\S]*?)(?=\n\d+\n\d{2}:\d{2}:\d{2},\d{3} -->|\n\s*$|$)/g;
        const results = []; let match;
        while ((match = regex.exec(cleanData)) !== null) results.push({ time: match[2].trim(), text: match[3].trim() });
        return results;
    }
    function createCell(content) {
        const div = document.createElement('div'); div.className = 'cell';
        div.innerHTML = `<span class="handle">‚†ø</span><div class="content" contenteditable="true">${content}</div><button class="btn-del" onclick="this.parentElement.remove()">‚úï</button>`;
        return div;
    }
    columns.forEach(col => Sortable.create(col, { animation: 150, handle: '.handle', ghostClass: 'sortable-ghost' }));
    const grid = document.getElementById('mainGrid');
    document.querySelectorAll('.resizer').forEach((resizer, index) => {
        resizer.addEventListener('mousedown', e => {
            const startX = e.pageX; const colWidths = window.getComputedStyle(grid).gridTemplateColumns.split(' ').map(w => parseFloat(w));
            const onMouseMove = e => {
                const delta = e.pageX - startX; const newWidths = [...colWidths]; newWidths[index] += delta;
                grid.style.gridTemplateColumns = newWidths.map((w, i) => i === 2 ? '1fr' : `${w}px`).join(' ');
            };
            const onMouseUp = () => { document.removeEventListener('mousemove', onMouseMove); document.removeEventListener('mouseup', onMouseUp); };
            document.addEventListener('mousemove', onMouseMove); document.addEventListener('mouseup', onMouseUp);
        });
    });
    function exportSRT() {
        const t = document.querySelectorAll('#list-time .content'); const s1 = document.querySelectorAll('#list-sub1 .content'); const s2 = document.querySelectorAll('#list-sub2 .content');
        const max = Math.max(t.length, s1.length, s2.length); let out = "";
        for (let i = 0; i < max; i++) {
            const text1 = s1[i]?.innerHTML.replace(/<br>/g, "\n").trim() || "";
            const text2 = s2[i]?.innerHTML.replace(/<br>/g, "\n").trim() || "";
            out += `${i+1}\n${t[i]?.innerText.trim() || "00:00:00,000 --> 00:00:00,000"}\n${text1}\n---\n${text2}\n\n`;
        }
        const blob = new Blob([out], {type: 'text/plain'}); const a = document.createElement('a');
        a.href = URL.createObjectURL(blob); a.download = "blurred_project.srt"; a.click();
    }
</script>
</body>
</html>